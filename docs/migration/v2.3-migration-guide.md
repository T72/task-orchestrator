# Migration Guide: v2.2 to v2.3

## Overview

Version 2.3 introduces Core Loop features that enhance task management with success criteria, feedback mechanisms, and metrics tracking. This guide walks you through the migration process step-by-step.

**Migration Time**: ~2 minutes  
**Risk Level**: Low (with backup)  
**Downtime**: None  
**Rollback Available**: Yes

## Prerequisites

- Task Orchestrator v2.2 or earlier installed
- Python 3.8+ (verify with `python3 --version`)
- At least 10MB free disk space
- Administrative access to your `.task-orchestrator` directory

## Step 1: Backup Your Data (CRITICAL)

**Always create a backup before migrating.** This ensures you can recover if anything goes wrong.

```bash
# Option 1: Full backup (recommended)
cp -r ~/.task-orchestrator ~/.task-orchestrator.backup-v2.2

# Option 2: Database-only backup (faster)
cp ~/.task-orchestrator/tasks.db ~/.task-orchestrator/tasks.db.backup-v2.2

# Verify backup was created
ls -la ~/.task-orchestrator.backup-v2.2/
```

## Step 2: Update Task Orchestrator

### If using Git:
```bash
cd task-orchestrator
git pull origin main
```

### If installed manually:
Download the latest release and replace your existing installation.

## Step 3: Apply Database Migration

The migration adds new optional fields for Core Loop features. Your existing data remains untouched.

```bash
# Apply the Core Loop migration
./tm migrate --apply

# Expected output:
# Backup created: ~/.task-orchestrator/backups/tasks_backup_[timestamp].db
# Applying migration 001: Add Core Loop fields...
# âœ“ Migration 001 applied
```

## Step 4: Verify Migration Success

```bash
# Check migration status
./tm migrate --status

# Expected output:
# Applied migrations: 001
# Pending migrations: None
# Up to date: Yes

# Test that existing tasks still work
./tm list
# Your existing tasks should appear unchanged
```

## Step 5: Test Core Loop Features (Optional)

Try out the new features to ensure everything works:

```bash
# Create a test task with new features
TEST_ID=$(./tm add "Migration test task" \
  --criteria '[{"criterion":"Test complete","measurable":"true"}]' \
  --estimated-hours 1 | grep -o '[a-f0-9]\{8\}')

# Complete with validation
./tm complete $TEST_ID --validate --actual-hours 0.5

# Clean up test task
./tm delete $TEST_ID
```

## Troubleshooting

### Error: "duplicate column name: success_criteria"

**Cause**: The migration has already been applied.  
**Solution**: This is safe to ignore. Check status with `./tm migrate --status`.

### Error: "no such table: tasks"

**Cause**: Database not initialized.  
**Solution**: Run `./tm init` first, then `./tm migrate --apply`.

### Error: "database is locked"

**Cause**: Another process is using the database.  
**Solution**: 
1. Close any other Task Orchestrator sessions
2. Wait a moment and try again
3. If persists, restart your terminal

### Error: "Migration 001 failed"

**Cause**: Database corruption or permission issues.  
**Solution**:
1. Restore from backup: `cp ~/.task-orchestrator.backup-v2.2/tasks.db ~/.task-orchestrator/tasks.db`
2. Try migration again
3. If still fails, contact support with error details

## Rollback Procedure

If you need to revert to v2.2:

### Method 1: Restore from Backup
```bash
# Stop using Task Orchestrator
# Restore the backup
rm -rf ~/.task-orchestrator
mv ~/.task-orchestrator.backup-v2.2 ~/.task-orchestrator

# Downgrade code to v2.2
cd task-orchestrator
git checkout v2.2.0
```

### Method 2: Use Migration Rollback
```bash
# Rollback the migration (if supported)
./tm migrate --rollback

# Note: This restores from the automatic backup created during migration
```

## What Changes After Migration?

### Database Schema
The following optional fields are added to the tasks table:
- `success_criteria` (TEXT) - JSON array of success criteria
- `feedback_quality` (INTEGER) - Quality score 1-5
- `feedback_timeliness` (INTEGER) - Timeliness score 1-5
- `feedback_notes` (TEXT) - Feedback comments
- `completion_summary` (TEXT) - Task completion summary
- `deadline` (TEXT) - Task deadline in ISO 8601
- `estimated_hours` (REAL) - Time estimate
- `actual_hours` (REAL) - Actual time spent

### Backward Compatibility
- All existing tasks work exactly as before
- Core Loop features are opt-in - use them when you're ready
- No changes to existing commands - only new options added
- Your workflow remains unchanged unless you explicitly use new features

## Configuration After Migration

Core Loop features are enabled by default but can be customized:

```bash
# View current configuration
./tm config --show

# Disable features you don't need
./tm config --disable telemetry
./tm config --disable feedback

# Use minimal mode (disables all Core Loop features)
./tm config --minimal-mode

# Reset to defaults
./tm config --reset
```

## Getting Started with Core Loop

After successful migration, try these commands:

```bash
# Add task with success criteria
./tm add "First Core Loop task" \
  --criteria '[{"criterion":"Task complete","measurable":"true"}]'

# Track progress
./tm progress <task-id> "Making progress..."

# Complete with validation
./tm complete <task-id> --validate

# View metrics
./tm metrics --feedback
```

## Need Help?

- **Documentation**: See `/docs/guides/troubleshooting.md`
- **Examples**: Check `/docs/examples/core-loop-examples.md`
- **Support**: Open an issue on GitHub

## Migration Checklist

- [ ] Backed up existing data
- [ ] Updated to v2.3 code
- [ ] Ran `./tm migrate --apply`
- [ ] Verified with `./tm migrate --status`
- [ ] Tested existing tasks still work
- [ ] (Optional) Tested new Core Loop features
- [ ] (Optional) Configured features to preference

## Summary

The v2.3 migration is designed to be safe and reversible. Your existing tasks and workflows continue working exactly as before, with new Core Loop features available when you need them. The migration takes less than 2 minutes and can be rolled back if needed.

Remember: **Always backup before migrating!**